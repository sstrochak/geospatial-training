---
title: "Geospatial Data in R"
author: "Sarah Strochak"
date: "5/10/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Geospatial data in R

Geospatial analysis is one of the fastest growing areas of R. In particular. special features provide a tidy way to analyze and visualize spatial data. 


### Why map in R?

Reproducabilty is key. Not only does mapping in R allow you to easily make many iterations of the same map, writing code provides a roadmap for others (and future you!) to figure out what was done.

There are several R packages that make it even more convenient to map in R:

* `sf`
* `tigris`
* `ggplot2`
* `urbnmapr`

### Some great resources:

* Robin Lovelace, Geocomputaion in R
* ALL of the vignettes for the `sf` package
* The Urban Institute mapping guide (major updates coming soon!)

## Reading in data

```{r libs, message=FALSE, warning=FALSE}

library(tidyverse)
library(sf)
library(urbnthemes)
library(urbnmapr)
library(tigris)

```

### Reading in shapefiles

```{r read-sf}

# msa_boundary <- st_read("get-dat-shapefile")

```

### Converting dataframes to `sf`

If you have a dataframe that contains latitude and longitude, you can easily convert your data to a `sf` ponit dataframe.

```{r read-csv, message=FALSE}

banks <- read_csv("data/fdic-sod-dc_2017.csv")

banks_sf <- banks %>% 
  filter(!is.na(sims_longitude), !is.na(sims_latitude)) %>% 
  st_as_sf(coords = c("sims_longitude", "sims_latitude")) %>% 
  st_set_crs(4326)

```


### Packages with data

`tigris` allows you to pull Census boundaries- states, tracts, CBSAs- even roads and military bases.

```{r tigris, results='hide'}

options(tigris_class = "sf")

tracts <- tigris::tracts(state = "11", cb = TRUE)

```

`urbnmapr` (sf support coming very, very soon) has states and counties with Alaska and Hawaii included, for making state and county maps- or can be used to pull data for individual states.

```{r urbnmapr}

dc <- get_urbn_map(map = "states", sf = TRUE) %>% 
  filter(state_fips == "11") %>% 
  st_transform(crs = 4326)

```

## Mapping

`geom_sf` from `ggplot2` allows you to map point, line, polygon, and multipolygon data. 
The syntax follow that of other `geom_*` functions- provide a data set and a set of aesthetics. If you are using an `sf` object with the coordinates saved in a column called `geometry`, you do not need to indicate that in the `aes()` call- this is the default.

You can layer geoms on top of each other; the they wil appear bottom to top.

```{r ggplot}

ggplot() +
  # geom_sf(msa_boundary, mapping = aes(), 
  #         fill = "grey") +
  geom_sf(banks_sf, mapping = aes()) +
  theme_urbn_map() +
  coord_sf(datum = NA)

```

## Clipping

`st_crop` will crop your data to the bouding box of another spatial data set.

```{r crop, warning=FALSE, message=FALSE}

banks_crop <- st_crop(banks_sf, dc)

ggplot() +
  geom_sf(dc, mapping = aes(), 
          fill = "grey") +
  geom_sf(banks_crop, mapping = aes()) +
  theme_urbn_map() +
  coord_sf(datum = NA)


```


`st_intersection` will provide an exact clip- closer to the "Clip" function from ArcGIS and other GIS software programs.

```{r intersection, warning=FALSE, message=FALSE}

banks_int <- st_intersection(banks_sf, dc)

ggplot() +
  geom_sf(dc, mapping = aes(), 
          fill = "grey") +
  geom_sf(banks_int, mapping = aes()) +
  theme_urbn_map() +
  coord_sf(datum = NA)


```

## Spatial joins

Instead of joining on an inditifier variables, you can join datasets on geometry.

Say, for instance, you want to figure out which census tracts in DC have the most FDIC-insured bank branches. The function `st_join` has many different options to equate geometries. The `sf` cheatsheet **ADD LINK** is a great resource for remembering and determining which function to use.

## Buffers

The `units` package is helpful for creating buffers withing having to reproject your data into the units you need for the buffer.
